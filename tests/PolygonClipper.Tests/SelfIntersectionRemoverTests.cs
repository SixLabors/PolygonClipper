// Copyright (c) Six Labors.
// Licensed under the Six Labors Split License.

namespace SixLabors.PolygonClipper.Tests;

public class SelfIntersectionRemoverTests
{
    /// <summary>
    /// Tests that a simple rectangle (single contour, no holes) is preserved.
    /// </summary>
    [Fact]
    public void SimpleRectangle_NoSelfIntersections_PreservesStructure()
    {
        // Arrange: Simple rectangle with closing vertex
        Contour outer = [];
        outer.AddVertex(new Vertex(0, 0));
        outer.AddVertex(new Vertex(10, 0));
        outer.AddVertex(new Vertex(10, 10));
        outer.AddVertex(new Vertex(0, 10));
        outer.AddVertex(new Vertex(0, 0)); // Closing vertex

        Polygon input = [outer];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert
        Assert.Equal(1, result.Count);
        Assert.Equal(5, result[0].Count); // 4 unique + 1 closing
        Assert.True(result[0].IsExternal);
    }

    /// <summary>
    /// Tests that a rectangle with a rectangular hole (2 contours) is preserved.
    /// </summary>
    [Fact]
    public void RectangleWithHole_NoSelfIntersections_PreservesStructure()
    {
        // Arrange: Outer rectangle
        Contour outer = [];
        outer.AddVertex(new Vertex(0, 0));
        outer.AddVertex(new Vertex(20, 0));
        outer.AddVertex(new Vertex(20, 20));
        outer.AddVertex(new Vertex(0, 20));
        outer.AddVertex(new Vertex(0, 0)); // Closing vertex

        // Inner rectangle (hole) - smaller, centered
        Contour inner = [];
        inner.AddVertex(new Vertex(5, 5));
        inner.AddVertex(new Vertex(15, 5));
        inner.AddVertex(new Vertex(15, 15));
        inner.AddVertex(new Vertex(5, 15));
        inner.AddVertex(new Vertex(5, 5)); // Closing vertex

        Polygon input = [outer, inner];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert
        Assert.Equal(2, result.Count);

        // First contour should be external (outer)
        Assert.True(result[0].IsExternal);
        Assert.Equal(5, result[0].Count);

        // Second contour should be a hole (inner)
        Assert.False(result[1].IsExternal);
        Assert.Equal(5, result[1].Count);
    }

    /// <summary>
    /// Tests a more complex shape similar to a stroked "O" - two concentric circles approximated as octagons.
    /// This tests that separate contours don't get incorrectly merged during reconstruction.
    /// </summary>
    [Fact]
    public void ConcentricOctagons_NoSelfIntersections_PreservesStructure()
    {
        // Arrange: Outer octagon (approximating outer circle)
        Contour outer = CreateOctagon(10, 10, 8);

        // Inner octagon (approximating inner circle/hole)
        Contour inner = CreateOctagon(10, 10, 4);

        Polygon input = [outer, inner];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert: Must have exactly 2 contours
        Assert.Equal(2, result.Count);
        Assert.True(result[0].IsExternal);
        Assert.False(result[1].IsExternal);
    }

    /// <summary>
    /// Tests concentric circles with many vertices to ensure no vertex matching issues.
    /// </summary>
    [Fact]
    public void ConcentricCircles_ManyVertices_PreservesStructure()
    {
        // Arrange: Create circles with 32 vertices each
        Contour outer = CreateRegularPolygon(0, 0, 100, 32);
        Contour inner = CreateRegularPolygon(0, 0, 50, 32);

        Polygon input = [outer, inner];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert: Must have exactly 2 contours
        Assert.Equal(2, result.Count);
        Assert.True(result[0].IsExternal);
        Assert.False(result[1].IsExternal);

        // Vertex counts should be preserved (32 + closing vertex = 33 each)
        Assert.Equal(33, result[0].Count);
        Assert.Equal(33, result[1].Count);
    }

    /// <summary>
    /// Tests concentric circles with vertex counts similar to real stroked text (283 outer, 305 inner).
    /// This simulates a stroked "O" character with high detail.
    /// </summary>
    [Fact]
    public void ConcentricCircles_StrokedTextScale_PreservesStructure()
    {
        // Arrange: Create circles matching real stroked text vertex counts
        const int outerVertices = 283;
        const int innerVertices = 305;

        Contour outer = CreateRegularPolygon(100, 100, 50, outerVertices);
        Contour inner = CreateRegularPolygon(100, 100, 45, innerVertices);

        Polygon input = [outer, inner];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert: Must have exactly 2 contours
        Assert.Equal(2, result.Count);
        Assert.True(result[0].IsExternal);
        Assert.False(result[1].IsExternal);

        // Vertex counts should be preserved
        Assert.Equal(outerVertices + 1, result[0].Count); // +1 for closing vertex
        Assert.Equal(innerVertices + 1, result[1].Count);
    }

    /// <summary>
    /// Tests real stroked text "O" shape data.
    /// Note: The input contours are compound paths - each contains two loops that share a vertex.
    /// This is typical of font glyph data where outer and inner boundaries are combined into single paths.
    /// The algorithm correctly separates these into distinct contours.
    /// </summary>
    [Fact]
    public void Test_Failing_StrokedText_O_Shape()
    {
        // Arrange: Create circles matching real stroked text vertex counts
        // Note: These contours are compound paths - they contain two loops each that share a vertex
        // The outer contour goes around the outer edge, returns to start, then goes around inner edge
        Contour outer =
        [
            new(1204.40380859375F, 717.1976928710938F),
            new(1204.3563232421875F, 720.1414794921875F),
            new(1204.2144775390625F, 723.016845703125F),
            new(1203.9774169921875F, 725.8305053710938F),
            new(1203.644775390625F, 728.5823364257812F),
            new(1203.21630859375F, 731.2721557617188F),
            new(1202.6915283203125F, 733.8997192382812F),
            new(1202.0701904296875F, 736.464599609375F),
            new(1201.3516845703125F, 738.9671020507812F),
            new(1200.536865234375F, 741.3987426757812F),
            new(1199.626708984375F, 743.7500610351562F),
            new(1198.6209716796875F, 746.0198364257812F),
            new(1197.5194091796875F, 748.2072143554688F),
            new(1196.3218994140625F, 750.311279296875F),
            new(1195.0283203125F, 752.3309936523438F),
            new(1193.638916015625F, 754.265380859375F),
            new(1192.1529541015625F, 756.1148071289062F),
            new(1190.5697021484375F, 757.8731689453125F),
            new(1188.891357421875F, 759.5310668945312F),
            new(1187.1202392578125F, 761.0853881835938F),
            new(1185.2579345703125F, 762.53564453125F),
            new(1183.30517578125F, 763.8809204101562F),
            new(1181.263671875F, 765.12060546875F),
            new(1179.134521484375F, 766.254638671875F),
            new(1176.9151611328125F, 767.2847290039062F),
            new(1174.602783203125F, 768.2029418945312F),
            new(1172.2027587890625F, 768.9976196289062F),
            new(1169.7203369140625F, 769.6678466796875F),
            new(1167.1568603515625F, 770.2142944335938F),
            new(1164.5128173828125F, 770.6377563476562F),
            new(1161.7890625F, 770.9391479492188F),
            new(1158.98583984375F, 771.1194458007812F),
            new(1156.103271484375F, 771.1792602539062F),
            new(1153.140380859375F, 771.1195068359375F),
            new(1150.265625F, 770.9395751953125F),
            new(1147.477294921875F, 770.6387939453125F),
            new(1144.77587890625F, 770.2160034179688F),
            new(1142.1617431640625F, 769.67041015625F),
            new(1139.6356201171875F, 769.0009765625F),
            new(1137.1983642578125F, 768.2068481445312F),
            new(1134.85546875F, 767.2889404296875F),
            new(1132.611083984375F, 766.258056640625F),
            new(1130.4617919921875F, 765.1215209960938F),
            new(1128.4049072265625F, 763.8776245117188F),
            new(1126.442138671875F, 762.5265502929688F),
            new(1124.5745849609375F, 761.0687255859375F),
            new(1122.8040771484375F, 759.5046997070312F),
            new(1121.1318359375F, 757.8358764648438F),
            new(1119.560791015625F, 756.0654907226562F),
            new(1118.092041015625F, 754.2050170898438F),
            new(1116.7218017578125F, 752.2606811523438F),
            new(1115.448486328125F, 750.23095703125F),
            new(1114.2724609375F, 748.1168823242188F),
            new(1113.193603515625F, 745.9197998046875F),
            new(1112.211669921875F, 743.640380859375F),
            new(1111.326416015625F, 741.279541015625F),
            new(1110.5380859375F, 738.8394165039062F),
            new(1109.8455810546875F, 736.3314208984375F),
            new(1109.24658203125F, 733.762939453125F),
            new(1108.7410888671875F, 731.1329956054688F),
            new(1108.3280029296875F, 728.4418334960938F),
            new(1108.00732421875F, 725.6895751953125F),
            new(1107.7786865234375F, 722.8762817382812F),
            new(1107.6419677734375F, 720.0023803710938F),
            new(1107.5963134765625F, 717.0606079101562F),
            new(1107.6773681640625F, 713.190673828125F),
            new(1107.921875F, 709.4261474609375F),
            new(1108.330322265625F, 705.7728271484375F),
            new(1108.90380859375F, 702.231201171875F),
            new(1109.6431884765625F, 698.802001953125F),
            new(1110.5491943359375F, 695.486083984375F),
            new(1111.622802734375F, 692.284423828125F),
            new(1112.8580322265625F, 689.2141723632812F),
            new(1113.553466796875F, 687.6968994140625F),
            new(1114.2864990234375F, 686.2340698242188F),
            new(1115.064208984375F, 684.8114013671875F),
            new(1115.8861083984375F, 683.4287719726562F),
            new(1116.7529296875F, 682.086669921875F),
            new(1117.6640625F, 680.7855834960938F),
            new(1118.6197509765625F, 679.5257568359375F),
            new(1119.6195068359375F, 678.3076782226562F),
            new(1120.663330078125F, 677.1317138671875F),
            new(1121.7508544921875F, 675.9981079101562F),
            new(1122.8819580078125F, 674.9072875976562F),
            new(1124.0562744140625F, 673.8594970703125F),
            new(1125.273193359375F, 672.8551025390625F),
            new(1126.5325927734375F, 671.89404296875F),
            new(1127.8341064453125F, 670.9766235351562F),
            new(1129.18017578125F, 670.1010131835938F),
            new(1130.5740966796875F, 669.2708740234375F),
            new(1132.0125732421875F, 668.4935913085938F),
            new(1133.4925537109375F, 667.7711181640625F),
            new(1135.0128173828125F, 667.1034545898438F),
            new(1136.57373046875F, 666.4904174804688F),
            new(1138.1741943359375F, 665.9320678710938F),
            new(1139.81396484375F, 665.427978515625F),
            new(1141.4927978515625F, 664.9780883789062F),
            new(1143.2105712890625F, 664.58203125F),
            new(1144.9669189453125F, 664.2398071289062F),
            new(1146.7615966796875F, 663.9508666992188F),
            new(1148.6126708984375F, 663.7127075195312F),
            new(1152.37353515625F, 663.4010009765625F),
            new(1156.3087158203125F, 663.2969360351562F),
            new(1160.0836181640625F, 663.4000854492188F),
            new(1163.7022705078125F, 663.709228515625F),
            new(1165.4892578125F, 663.945556640625F),
            new(1167.223388671875F, 664.2321166992188F),
            new(1168.9228515625F, 664.571533203125F),
            new(1170.5877685546875F, 664.964111328125F),
            new(1172.2178955078125F, 665.4100341796875F),
            new(1173.812744140625F, 665.9094848632812F),
            new(1175.3719482421875F, 666.4625854492188F),
            new(1176.895263671875F, 667.0695190429688F),
            new(1178.3822021484375F, 667.7303466796875F),
            new(1179.8323974609375F, 668.4451293945312F),
            new(1181.2452392578125F, 669.2137451171875F),
            new(1182.6177978515625F, 670.0346069335938F),
            new(1183.94677734375F, 670.9011840820312F),
            new(1185.23388671875F, 671.8099365234375F),
            new(1186.4813232421875F, 672.7622680664062F),
            new(1187.6885986328125F, 673.7582397460938F),
            new(1188.8551025390625F, 674.7974853515625F),
            new(1189.9810791015625F, 675.879638671875F),
            new(1191.0657958984375F, 677.004638671875F),
            new(1192.109130859375F, 678.1719970703125F),
            new(1193.111083984375F, 679.381591796875F),
            new(1194.0711669921875F, 680.6329345703125F),
            new(1194.9891357421875F, 681.925537109375F),
            new(1195.8653564453125F, 683.2590942382812F),
            new(1196.69970703125F, 684.633544921875F),
            new(1197.4918212890625F, 686.0482788085938F),
            new(1198.2420654296875F, 687.5028686523438F),
            new(1198.958740234375F, 689.0149536132812F),
            new(1200.237060546875F, 692.0859375F),
            new(1201.3487548828125F, 695.3023071289062F),
            new(1202.2864990234375F, 698.6441040039062F),
            new(1203.0516357421875F, 702.1101684570312F),
            new(1203.644775390625F, 705.6995849609375F),
            new(1204.0672607421875F, 709.4118041992188F),
            new(1204.31982421875F, 713.246337890625F),
            new(1204.40380859375F, 717.1976928710938F),
            new(1199.3232421875F, 713.4638671875F),
            new(1199.0858154296875F, 709.8590698242188F),
            new(1198.691162109375F, 706.3902587890625F),
            new(1198.1402587890625F, 703.0573120117188F),
            new(1197.4344482421875F, 699.8593139648438F),
            new(1196.5748291015625F, 696.7957153320312F),
            new(1195.561767578125F, 693.8651123046875F),
            new(1194.388916015625F, 691.0475463867188F),
            new(1193.7598876953125F, 689.7202758789062F),
            new(1193.0872802734375F, 688.4163208007812F),
            new(1192.3798828125F, 687.1529541015625F),
            new(1191.6375732421875F, 685.9299926757812F),
            new(1190.8602294921875F, 684.746826171875F),
            new(1190.0479736328125F, 683.603271484375F),
            new(1189.200927734375F, 682.4991455078125F),
            new(1188.318603515625F, 681.4339599609375F),
            new(1187.4007568359375F, 680.4071044921875F),
            new(1186.4476318359375F, 679.4185791015625F),
            new(1185.4586181640625F, 678.4678955078125F),
            new(1184.4334716796875F, 677.5547485351562F),
            new(1183.3721923828125F, 676.6792602539062F),
            new(1182.27392578125F, 675.8406982421875F),
            new(1181.138427734375F, 675.0390014648438F),
            new(1179.9681396484375F, 674.2759399414062F),
            new(1178.7662353515625F, 673.55712890625F),
            new(1177.5316162109375F, 672.8854370117188F),
            new(1176.2608642578125F, 672.2591552734375F),
            new(1174.953857421875F, 671.6782836914062F),
            new(1173.6102294921875F, 671.1428833007812F),
            new(1172.229248046875F, 670.6530151367188F),
            new(1170.8106689453125F, 670.208740234375F),
            new(1169.3541259765625F, 669.810302734375F),
            new(1167.859130859375F, 669.4578857421875F),
            new(1166.325927734375F, 669.1516723632812F),
            new(1164.753662109375F, 668.891845703125F),
            new(1163.1614990234375F, 668.6812744140625F),
            new(1159.8023681640625F, 668.3942260742188F),
            new(1156.3065185546875F, 668.2987670898438F),
            new(1152.646240234375F, 668.3955078125F),
            new(1149.1385498046875F, 668.6862182617188F),
            new(1147.4781494140625F, 668.8998413085938F),
            new(1145.8426513671875F, 669.1631469726562F),
            new(1144.2508544921875F, 669.473388671875F),
            new(1142.7020263671875F, 669.8305053710938F),
            new(1141.196044921875F, 670.2340087890625F),
            new(1139.7327880859375F, 670.6837768554688F),
            new(1138.311767578125F, 671.1796264648438F),
            new(1136.9327392578125F, 671.7212524414062F),
            new(1135.5953369140625F, 672.30859375F),
            new(1134.2987060546875F, 672.9415893554688F),
            new(1133.0428466796875F, 673.6201171875F),
            new(1131.82373046875F, 674.3462524414062F),
            new(1130.6385498046875F, 675.1171264648438F),
            new(1129.4906005859375F, 675.92626953125F),
            new(1128.38232421875F, 676.7720947265625F),
            new(1127.3131103515625F, 677.6544189453125F),
            new(1126.2830810546875F, 678.5735473632812F),
            new(1125.2916259765625F, 679.5297241210938F),
            new(1124.33837890625F, 680.5233154296875F),
            new(1123.4229736328125F, 681.5546264648438F),
            new(1122.5452880859375F, 682.6239013671875F),
            new(1121.705078125F, 683.7315063476562F),
            new(1120.90234375F, 684.8780517578125F),
            new(1120.1365966796875F, 686.0635375976562F),
            new(1119.408203125F, 687.288818359375F),
            new(1118.7166748046875F, 688.5540161132812F),
            new(1118.0625F, 689.8592529296875F),
            new(1117.4525146484375F, 691.1901245117188F),
            new(1116.31640625F, 694.0137939453125F),
            new(1115.3350830078125F, 696.94091796875F),
            new(1114.5023193359375F, 699.98876953125F),
            new(1113.81884765625F, 703.158447265625F),
            new(1113.28564453125F, 706.45068359375F),
            new(1112.90380859375F, 709.8662109375F),
            new(1112.6739501953125F, 713.4051513671875F),
            new(1112.5970458984375F, 717.0741577148438F),
            new(1112.6400146484375F, 719.8446655273438F),
            new(1112.7691650390625F, 722.5548706054688F),
            new(1112.98388671875F, 725.1976318359375F),
            new(1113.2838134765625F, 727.7730102539062F),
            new(1113.6688232421875F, 730.2814331054688F),
            new(1114.13818359375F, 732.7227783203125F),
            new(1114.6920166015625F, 735.09765625F),
            new(1115.3291015625F, 737.4047241210938F),
            new(1116.048828125F, 739.63232421875F),
            new(1116.851318359375F, 741.7724609375F),
            new(1117.736572265625F, 743.8275146484375F),
            new(1118.7041015625F, 745.7981567382812F),
            new(1119.75390625F, 747.685302734375F),
            new(1120.8861083984375F, 749.4899291992188F),
            new(1122.100830078125F, 751.2135620117188F),
            new(1123.396240234375F, 752.8544311523438F),
            new(1124.77099609375F, 754.4037475585938F),
            new(1126.2283935546875F, 755.8580932617188F),
            new(1127.7711181640625F, 757.2208251953125F),
            new(1129.400634765625F, 758.4929809570312F),
            new(1131.1185302734375F, 759.6754760742188F),
            new(1132.9261474609375F, 760.7686157226562F),
            new(1134.824951171875F, 761.772705078125F),
            new(1136.8125F, 762.6856689453125F),
            new(1138.8863525390625F, 763.4981079101562F),
            new(1141.0516357421875F, 764.20361328125F),
            new(1143.3138427734375F, 764.8031005859375F),
            new(1145.673828125F, 765.2957153320312F),
            new(1148.13232421875F, 765.680419921875F),
            new(1150.690185546875F, 765.9564208984375F),
            new(1153.346923828125F, 766.1226806640625F),
            new(1156.101806640625F, 766.1781616210938F),
            new(1158.7734375F, 766.1227416992188F),
            new(1161.353515625F, 765.9568481445312F),
            new(1163.8421630859375F, 765.6814575195312F),
            new(1166.2396240234375F, 765.2974243164062F),
            new(1168.5467529296875F, 764.8056640625F),
            new(1170.7640380859375F, 764.2069702148438F),
            new(1172.892822265625F, 763.5021362304688F),
            new(1174.9383544921875F, 762.6898803710938F),
            new(1176.905029296875F, 761.777099609375F),
            new(1178.788818359375F, 760.773681640625F),
            new(1180.587158203125F, 759.6818237304688F),
            new(1182.3011474609375F, 758.5009765625F),
            new(1183.9324951171875F, 757.2306518554688F),
            new(1185.482421875F, 755.8703002929688F),
            new(1186.9517822265625F, 754.4188232421875F),
            new(1188.3431396484375F, 752.8734741210938F),
            new(1189.65673828125F, 751.23876953125F),
            new(1190.8896484375F, 749.5222778320312F),
            new(1192.0408935546875F, 747.724609375F),
            new(1193.1109619140625F, 745.8445434570312F),
            new(1194.0997314453125F, 743.8812866210938F),
            new(1195.007080078125F, 741.8336791992188F),
            new(1195.83251953125F, 739.7011108398438F),
            new(1196.5760498046875F, 737.4821166992188F),
            new(1197.2354736328125F, 735.185546875F),
            new(1197.8082275390625F, 732.8211059570312F),
            new(1198.2939453125F, 730.3889770507812F),
            new(1198.692138671875F, 727.8888549804688F),
            new(1199.0025634765625F, 725.3204956054688F),
            new(1199.2247314453125F, 722.68359375F),
            new(1199.3582763671875F, 719.9779052734375F),
            new(1199.40283203125F, 717.2105102539062F),
            new(1199.3232421875F, 713.4638671875F),
            new(1204.40380859375F, 717.1976928710938F),
        ];

        Contour inner =
        [
            new(1124.8333740234375F, 717.2041625976562F),
            new(1124.888427734375F, 720.2365112304688F),
            new(1125.0526123046875F, 723.1566772460938F),
            new(1125.3255615234375F, 725.9636840820312F),
            new(1125.7060546875F, 728.657470703125F),
            new(1126.193359375F, 731.2381591796875F),
            new(1126.7864990234375F, 733.7061767578125F),
            new(1127.484375F, 736.0621948242188F),
            new(1128.2916259765625F, 738.3222045898438F),
            new(1128.72265625F, 739.3775024414062F),
            new(1129.1865234375F, 740.4131469726562F),
            new(1129.676513671875F, 741.4146118164062F),
            new(1130.1932373046875F, 742.38232421875F),
            new(1130.736083984375F, 743.3167724609375F),
            new(1131.30517578125F, 744.2178344726562F),
            new(1131.9005126953125F, 745.08642578125F),
            new(1132.5220947265625F, 745.9226684570312F),
            new(1133.170166015625F, 746.7271728515625F),
            new(1133.8447265625F, 747.5003051757812F),
            new(1134.5458984375F, 748.2423095703125F),
            new(1135.2742919921875F, 748.9536743164062F),
            new(1136.0299072265625F, 749.6348266601562F),
            new(1136.8131103515625F, 750.2860107421875F),
            new(1137.624755859375F, 750.907470703125F),
            new(1138.4619140625F, 751.4976806640625F),
            new(1139.3226318359375F, 752.0517578125F),
            new(1140.2109375F, 752.5693969726562F),
            new(1141.1298828125F, 753.0524291992188F),
            new(1142.08056640625F, 753.5009765625F),
            new(1143.0633544921875F, 753.9150390625F),
            new(1144.0787353515625F, 754.2945556640625F),
            new(1145.1270751953125F, 754.63916015625F),
            new(1146.2091064453125F, 754.94873046875F),
            new(1147.3250732421875F, 755.2230834960938F),
            new(1148.4752197265625F, 755.4618530273438F),
            new(1149.65966796875F, 755.6646118164062F),
            new(1150.8592529296875F, 755.82861328125F),
            new(1153.42236328125F, 756.0538940429688F),
            new(1156.1026611328125F, 756.12890625F),
            new(1158.7982177734375F, 756.0538330078125F),
            new(1161.3724365234375F, 755.8284912109375F),
            new(1162.57568359375F, 755.6644897460938F),
            new(1163.7626953125F, 755.461669921875F),
            new(1164.9140625F, 755.2229614257812F),
            new(1166.0301513671875F, 754.94873046875F),
            new(1167.1109619140625F, 754.6393432617188F),
            new(1168.156982421875F, 754.2950439453125F),
            new(1169.168701171875F, 753.916015625F),
            new(1170.1466064453125F, 753.5025634765625F),
            new(1171.09130859375F, 753.0547485351562F),
            new(1172.003173828125F, 752.5726928710938F),
            new(1172.8829345703125F, 752.0562744140625F),
            new(1173.734619140625F, 751.50341796875F),
            new(1174.562744140625F, 750.9142456054688F),
            new(1175.365478515625F, 750.29345703125F),
            new(1176.1400146484375F, 749.6431274414062F),
            new(1176.8870849609375F, 748.9627075195312F),
            new(1177.6068115234375F, 748.252197265625F),
            new(1178.299560546875F, 747.5107421875F),
            new(1178.9659423828125F, 746.7383422851562F),
            new(1179.60546875F, 745.9346313476562F),
            new(1180.21875F, 745.0989379882812F),
            new(1180.805908203125F, 744.2308959960938F),
            new(1181.366943359375F, 743.3301391601562F),
            new(1181.901611328125F, 742.3961791992188F),
            new(1182.4102783203125F, 741.4287719726562F),
            new(1182.892333984375F, 740.427734375F),
            new(1183.347900390625F, 739.392333984375F),
            new(1183.7713623046875F, 738.336669921875F),
            new(1184.5635986328125F, 736.0755004882812F),
            new(1185.248779296875F, 733.7176513671875F),
            new(1185.831298828125F, 731.2474975585938F),
            new(1186.309814453125F, 728.6649169921875F),
            new(1186.6834716796875F, 725.9691772460938F),
            new(1186.951416015625F, 723.1602172851562F),
            new(1187.1126708984375F, 720.23828125F),
            new(1187.1663818359375F, 717.2155151367188F),
            new(1187.0433349609375F, 712.6398315429688F),
            new(1186.6748046875F, 708.3317260742188F),
            new(1186.4039306640625F, 706.3126220703125F),
            new(1186.0704345703125F, 704.3439331054688F),
            new(1185.677978515625F, 702.4451904296875F),
            new(1185.2266845703125F, 700.6165161132812F),
            new(1184.7171630859375F, 698.8571166992188F),
            new(1184.1500244140625F, 697.1669921875F),
            new(1183.5257568359375F, 695.5458374023438F),
            new(1182.8446044921875F, 693.9927368164062F),
            new(1182.1072998046875F, 692.507080078125F),
            new(1181.3138427734375F, 691.0883178710938F),
            new(1180.4644775390625F, 689.7352294921875F),
            new(1179.5513916015625F, 688.4357299804688F),
            new(1179.0928955078125F, 687.8388061523438F),
            new(1178.6114501953125F, 687.2518920898438F),
            new(1178.11474609375F, 686.68505859375F),
            new(1177.6029052734375F, 686.1383666992188F),
            new(1177.0760498046875F, 685.6116333007812F),
            new(1176.53369140625F, 685.1045532226562F),
            new(1175.975341796875F, 684.6165771484375F),
            new(1175.4012451171875F, 684.1477661132812F),
            new(1174.811279296875F, 683.6981811523438F),
            new(1174.2049560546875F, 683.2673950195312F),
            new(1173.5819091796875F, 682.855224609375F),
            new(1172.9422607421875F, 682.4617309570312F),
            new(1172.285400390625F, 682.0867919921875F),
            new(1171.6287841796875F, 681.7395629882812F),
            new(1170.20947265625F, 681.0736694335938F),
            new(1168.736328125F, 680.4906005859375F),
            new(1167.189453125F, 679.9822387695312F),
            new(1165.5675048828125F, 679.5494384765625F),
            new(1163.869384765625F, 679.1930541992188F),
            new(1162.0948486328125F, 678.9140625F),
            new(1160.2427978515625F, 678.7136840820312F),
            new(1158.3134765625F, 678.5927734375F),
            new(1156.316650390625F, 678.5524291992188F),
            new(1153.6082763671875F, 678.6268310546875F),
            new(1151.0269775390625F, 678.849365234375F),
            new(1149.818359375F, 679.011474609375F),
            new(1148.625244140625F, 679.2117919921875F),
            new(1147.4669189453125F, 679.44775390625F),
            new(1146.3431396484375F, 679.71875F),
            new(1145.2535400390625F, 680.0247192382812F),
            new(1144.1978759765625F, 680.3651733398438F),
            new(1143.17578125F, 680.7400512695312F),
            new(1142.1866455078125F, 681.1491088867188F),
            new(1141.2301025390625F, 681.5921630859375F),
            new(1140.305419921875F, 682.0693359375F),
            new(1139.4122314453125F, 682.580322265625F),
            new(1138.5469970703125F, 683.1272583007812F),
            new(1137.70556640625F, 683.709716796875F),
            new(1136.8900146484375F, 684.3231811523438F),
            new(1136.102783203125F, 684.9659423828125F),
            new(1135.3433837890625F, 685.6384887695312F),
            new(1134.611328125F, 686.3408203125F),
            new(1133.9063720703125F, 687.073486328125F),
            new(1133.228271484375F, 687.8366088867188F),
            new(1132.5770263671875F, 688.6307983398438F),
            new(1131.951904296875F, 689.456787109375F),
            new(1131.3531494140625F, 690.3143310546875F),
            new(1130.78076171875F, 691.2041625976562F),
            new(1130.2344970703125F, 692.1268310546875F),
            new(1129.714599609375F, 693.0824584960938F),
            new(1129.220947265625F, 694.0714721679688F),
            new(1128.75390625F, 695.09423828125F),
            new(1128.31982421875F, 696.1355590820312F),
            new(1127.5064697265625F, 698.369873046875F),
            new(1126.8033447265625F, 700.7049560546875F),
            new(1126.205322265625F, 703.157958984375F),
            new(1125.7138671875F, 705.7295532226562F),
            new(1125.3299560546875F, 708.4199829101562F),
            new(1125.0546875F, 711.2294921875F),
            new(1124.8887939453125F, 714.1577758789062F),
            new(1124.8333740234375F, 717.2041625976562F),
            new(1119.8914794921875F, 713.9708862304688F),
            new(1120.068603515625F, 710.8441162109375F),
            new(1120.3646240234375F, 707.8226928710938F),
            new(1120.78076171875F, 704.9066772460938F),
            new(1121.31787109375F, 702.095947265625F),
            new(1121.9771728515625F, 699.39111328125F),
            new(1122.7596435546875F, 696.7926025390625F),
            new(1123.66064453125F, 694.3175659179688F),
            new(1124.1708984375F, 693.09326171875F),
            new(1124.708740234375F, 691.9158325195312F),
            new(1125.2802734375F, 690.7705688476562F),
            new(1125.8858642578125F, 689.657470703125F),
            new(1126.525634765625F, 688.5770874023438F),
            new(1127.1993408203125F, 687.5296630859375F),
            new(1127.9072265625F, 686.5157470703125F),
            new(1128.6490478515625F, 685.5357055664062F),
            new(1129.4248046875F, 684.5896606445312F),
            new(1130.2344970703125F, 683.67822265625F),
            new(1131.07763671875F, 682.802001953125F),
            new(1131.9537353515625F, 681.9613647460938F),
            new(1132.863037109375F, 681.15625F),
            new(1133.8048095703125F, 680.3872680664062F),
            new(1134.77880859375F, 679.6546630859375F),
            new(1135.7869873046875F, 678.9567260742188F),
            new(1136.8336181640625F, 678.2950439453125F),
            new(1137.91650390625F, 677.675537109375F),
            new(1139.0321044921875F, 677.0999755859375F),
            new(1140.1795654296875F, 676.5684204101562F),
            new(1141.35888671875F, 676.0807495117188F),
            new(1142.5689697265625F, 675.6369018554688F),
            new(1143.8099365234375F, 675.2367553710938F),
            new(1145.0806884765625F, 674.8798828125F),
            new(1146.3814697265625F, 674.566162109375F),
            new(1147.7119140625F, 674.295166015625F),
            new(1149.07177734375F, 674.0667724609375F),
            new(1150.4796142578125F, 673.8780517578125F),
            new(1153.3245849609375F, 673.6326904296875F),
            new(1156.298583984375F, 673.5510864257812F),
            new(1158.5205078125F, 673.595947265625F),
            new(1160.6683349609375F, 673.7305297851562F),
            new(1162.7523193359375F, 673.9560546875F),
            new(1164.771728515625F, 674.2734985351562F),
            new(1166.7264404296875F, 674.6837158203125F),
            new(1168.61572265625F, 675.1878051757812F),
            new(1170.4384765625F, 675.786865234375F),
            new(1172.193359375F, 676.4815063476562F),
            new(1173.8607177734375F, 677.2637329101562F),
            new(1174.694091796875F, 677.7044677734375F),
            new(1175.4920654296875F, 678.1599731445312F),
            new(1176.2718505859375F, 678.6396484375F),
            new(1177.0330810546875F, 679.1432495117188F),
            new(1177.775390625F, 679.6707153320312F),
            new(1178.4986572265625F, 680.2218627929688F),
            new(1179.20263671875F, 680.7967529296875F),
            new(1179.886962890625F, 681.3948364257812F),
            new(1180.5518798828125F, 682.0162963867188F),
            new(1181.1966552734375F, 682.6609497070312F),
            new(1181.821044921875F, 683.3280029296875F),
            new(1182.4254150390625F, 684.0176391601562F),
            new(1183.0096435546875F, 684.7296752929688F),
            new(1183.5814208984375F, 685.4744262695312F),
            new(1184.6302490234375F, 686.966796875F),
            new(1185.6160888671875F, 688.5372924804688F),
            new(1186.5313720703125F, 690.174072265625F),
            new(1187.3760986328125F, 691.8760375976562F),
            new(1188.1507568359375F, 693.6423950195312F),
            new(1188.8553466796875F, 695.4725341796875F),
            new(1189.4906005859375F, 697.3656616210938F),
            new(1190.0570068359375F, 699.3214721679688F),
            new(1190.55517578125F, 701.3397216796875F),
            new(1190.9852294921875F, 703.4201049804688F),
            new(1191.3480224609375F, 705.5623779296875F),
            new(1191.646484375F, 707.7859497070312F),
            new(1192.0374755859375F, 712.3593139648438F),
            new(1192.1676025390625F, 717.1926879882812F),
            new(1192.1102294921875F, 720.4205322265625F),
            new(1191.938232421875F, 723.5355834960938F),
            new(1191.6507568359375F, 726.5501098632812F),
            new(1191.246826171875F, 729.4639892578125F),
            new(1190.7255859375F, 732.2774047851562F),
            new(1190.0859375F, 734.9898681640625F),
            new(1189.3272705078125F, 737.6008911132812F),
            new(1188.4532470703125F, 740.094970703125F),
            new(1187.957763671875F, 741.3304443359375F),
            new(1187.434326171875F, 742.5198974609375F),
            new(1186.8768310546875F, 743.6775512695312F),
            new(1186.285400390625F, 744.8025512695312F),
            new(1185.659912109375F, 745.8948364257812F),
            new(1185.000244140625F, 746.9540405273438F),
            new(1184.306640625F, 747.9797973632812F),
            new(1183.57861328125F, 748.9716186523438F),
            new(1182.8165283203125F, 749.9292602539062F),
            new(1182.020751953125F, 750.851806640625F),
            new(1181.1912841796875F, 751.739501953125F),
            new(1180.3282470703125F, 752.5914916992188F),
            new(1179.4324951171875F, 753.4074096679688F),
            new(1178.503662109375F, 754.1873779296875F),
            new(1177.54248046875F, 754.9304809570312F),
            new(1176.546630859375F, 755.63916015625F),
            new(1175.5111083984375F, 756.3114013671875F),
            new(1174.438232421875F, 756.9411010742188F),
            new(1173.33154296875F, 757.5260620117188F),
            new(1172.1920166015625F, 758.0662841796875F),
            new(1171.02001953125F, 758.561767578125F),
            new(1169.81640625F, 759.0126953125F),
            new(1168.5811767578125F, 759.4192504882812F),
            new(1167.3150634765625F, 759.78173828125F),
            new(1166.0185546875F, 760.1002807617188F),
            new(1164.691650390625F, 760.3753662109375F),
            new(1163.334716796875F, 760.6072387695312F),
            new(1161.9283447265625F, 760.7989501953125F),
            new(1159.0860595703125F, 761.0477294921875F),
            new(1156.1024169921875F, 761.130859375F),
            new(1153.13330078125F, 761.0477905273438F),
            new(1150.3013916015625F, 760.798828125F),
            new(1148.89892578125F, 760.6071166992188F),
            new(1147.5447998046875F, 760.3753051757812F),
            new(1146.2198486328125F, 760.1001586914062F),
            new(1144.9241943359375F, 759.78173828125F),
            new(1143.6580810546875F, 759.41943359375F),
            new(1142.4222412109375F, 759.01318359375F),
            new(1141.2166748046875F, 758.5626220703125F),
            new(1140.042236328125F, 758.06787109375F),
            new(1138.89892578125F, 757.5283813476562F),
            new(1137.787841796875F, 756.9443969726562F),
            new(1136.7093505859375F, 756.31591796875F),
            new(1135.6669921875F, 755.6448974609375F),
            new(1134.6630859375F, 754.937255859375F),
            new(1133.6937255859375F, 754.19482421875F),
            new(1132.7564697265625F, 753.4157104492188F),
            new(1131.8521728515625F, 752.6005249023438F),
            new(1130.980712890625F, 751.749267578125F),
            new(1130.142578125F, 750.8623657226562F),
            new(1129.338134765625F, 749.9404296875F),
            new(1128.5672607421875F, 748.9835815429688F),
            new(1127.8304443359375F, 747.9923095703125F),
            new(1127.127685546875F, 746.9671020507812F),
            new(1126.459228515625F, 745.9083251953125F),
            new(1125.8248291015625F, 744.81640625F),
            new(1125.224365234375F, 743.6917114257812F),
            new(1124.657958984375F, 742.5344848632812F),
            new(1124.12548828125F, 741.3452758789062F),
            new(1123.6204833984375F, 740.1094360351562F),
            new(1122.7294921875F, 737.6141967773438F),
            new(1121.9554443359375F, 735.0013427734375F),
            new(1121.302978515625F, 732.286865234375F),
            new(1120.771484375F, 729.471435546875F),
            new(1120.3594970703125F, 726.5556030273438F),
            new(1120.0662841796875F, 723.5391235351562F),
            new(1119.890869140625F, 720.4223022460938F),
            new(1119.8326416015625F, 717.2040405273438F),
            new(1119.8914794921875F, 713.9708862304688F),
            new(1124.8333740234375F, 717.2041625976562F),
        ];

        Polygon input = [outer, inner];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert: The input has 2 compound contours, each containing 2 loops connected by
        // degenerate "bridge" segments (same line traversed in opposite directions).
        // After processing, the bridge segments cancel out, leaving 2 proper closed contours:
        // - 1 external (the outer boundary of the stroked O)
        // - 1 hole (the inner boundary of the stroked O)
        Assert.Equal(2, result.Count);
        Assert.True(result[0].IsExternal);
        Assert.False(result[1].IsExternal);
    }

    /// <summary>
    /// Tests with even larger vertex counts to stress test the algorithm.
    /// </summary>
    [Fact]
    public void ConcentricCircles_LargeVertexCount_PreservesStructure()
    {
        // Arrange: Create high-resolution circles
        const int outerVertices = 500;
        const int innerVertices = 450;

        Contour outer = CreateRegularPolygon(0, 0, 200, outerVertices);
        Contour inner = CreateRegularPolygon(0, 0, 150, innerVertices);

        Polygon input = [outer, inner];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert: Must have exactly 2 contours
        Assert.Equal(2, result.Count);
        Assert.True(result[0].IsExternal);
        Assert.False(result[1].IsExternal);

        // Vertex counts should be preserved
        Assert.Equal(outerVertices + 1, result[0].Count);
        Assert.Equal(innerVertices + 1, result[1].Count);
    }

    /// <summary>
    /// Tests multiple nested contours (like a target or bullseye pattern).
    /// </summary>
    [Fact]
    public void MultipleNestedContours_PreservesHierarchy()
    {
        // Arrange: Create 4 concentric circles (alternating external/hole)
        Contour ring1 = CreateRegularPolygon(0, 0, 100, 64); // Outermost external
        Contour ring2 = CreateRegularPolygon(0, 0, 80, 64);  // Hole in ring1
        Contour ring3 = CreateRegularPolygon(0, 0, 60, 64);  // External inside ring2's hole
        Contour ring4 = CreateRegularPolygon(0, 0, 40, 64);  // Hole in ring3

        Polygon input = [ring1, ring2, ring3, ring4];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert: Must have exactly 4 contours
        Assert.Equal(4, result.Count);

        // Check depths: 0, 1, 2, 3 (alternating external/hole based on even/odd)
        // Even depth = external-like, odd depth = hole-like
        Assert.Equal(0, result[0].Depth); // ring1 - outermost
        Assert.Equal(1, result[1].Depth); // ring2 - hole in ring1
        Assert.Equal(2, result[2].Depth); // ring3 - inside ring2
        Assert.Equal(3, result[3].Depth); // ring4 - hole in ring3
    }

    /// <summary>
    /// Tests two separate (non-nested) polygons to ensure they remain separate.
    /// </summary>
    [Fact]
    public void TwoSeparatePolygons_RemainSeparate()
    {
        // Arrange: Two non-overlapping circles
        Contour circle1 = CreateRegularPolygon(-100, 0, 30, 100);
        Contour circle2 = CreateRegularPolygon(100, 0, 30, 100);

        Polygon input = [circle1, circle2];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert: Must have exactly 2 separate external contours
        Assert.Equal(2, result.Count);
        Assert.True(result[0].IsExternal);
        Assert.True(result[1].IsExternal);

        // Vertex counts preserved
        Assert.Equal(101, result[0].Count);
        Assert.Equal(101, result[1].Count);
    }

    /// <summary>
    /// Tests a complex shape with multiple holes (like the letter "8" or "B").
    /// </summary>
    [Fact]
    public void ExternalWithMultipleHoles_PreservesStructure()
    {
        // Arrange: Outer rectangle with two circular holes
        Contour outer = [];
        outer.AddVertex(new Vertex(0, 0));
        outer.AddVertex(new Vertex(100, 0));
        outer.AddVertex(new Vertex(100, 200));
        outer.AddVertex(new Vertex(0, 200));
        outer.AddVertex(new Vertex(0, 0));

        Contour hole1 = CreateRegularPolygon(50, 50, 20, 32);
        Contour hole2 = CreateRegularPolygon(50, 150, 20, 32);

        Polygon input = [outer, hole1, hole2];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert: 1 external + 2 holes
        Assert.Equal(3, result.Count);
        Assert.True(result[0].IsExternal);
        Assert.False(result[1].IsExternal);
        Assert.False(result[2].IsExternal);
    }

    /// <summary>
    /// Tests that actual self-intersections are detected and handled.
    /// A figure-8 shape has a self-intersection at the center.
    /// </summary>
    [Fact]
    public void FigureEight_WithSelfIntersection_SplitsIntoTwoContours()
    {
        // Arrange: Figure-8 shape that crosses itself at (5, 0)
        // First loop: (0,0) -> (10,5) -> (10,-5) -> (0,0) but path crosses at (5,0)
        // Using a bowtie/hourglass shape that definitely crosses
        Contour figure8 = [];
        figure8.AddVertex(new Vertex(0, 5));    // Top-left
        figure8.AddVertex(new Vertex(10, -5));  // Bottom-right (crosses the next segment)
        figure8.AddVertex(new Vertex(10, 5));   // Top-right
        figure8.AddVertex(new Vertex(0, -5));   // Bottom-left (crosses back)
        figure8.AddVertex(new Vertex(0, 5));    // Back to start

        Polygon input = [figure8];

        // Act
        Polygon result = PolygonClipper.RemoveSelfIntersections(input);

        // Assert: Should produce 2 separate triangular contours (the two halves of the bowtie)
        Assert.Equal(2, result.Count);
    }

    /// <summary>
    /// Helper method to create a regular octagon centered at (cx, cy) with given radius.
    /// </summary>
    private static Contour CreateOctagon(double cx, double cy, double radius)
        => CreateRegularPolygon(cx, cy, radius, 8);

    /// <summary>
    /// Helper method to create a regular polygon with n vertices centered at (cx, cy) with given radius.
    /// </summary>
    private static Contour CreateRegularPolygon(double cx, double cy, double radius, int vertices)
    {
        Contour contour = [];
        for (int i = 0; i < vertices; i++)
        {
            double angle = i * 2 * Math.PI / vertices;
            double x = cx + (radius * Math.Cos(angle));
            double y = cy + (radius * Math.Sin(angle));
            contour.AddVertex(new Vertex(x, y));
        }

        // Add closing vertex
        contour.AddVertex(new Vertex(cx + radius, cy)); // Same as first vertex (angle=0)

        return contour;
    }
}
